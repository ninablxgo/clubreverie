<script>
  const channel = "clubreverie";
  let socket;
  let currentNick = "";

  // Pré-remplir le pseudo si déjà sauvegardé
  window.onload = () => {
    const savedNick = localStorage.getItem("nickname");
    if (savedNick) {
      document.getElementById("nick").value = savedNick;
    }
  };

  function connect(nick) {
    socket = new WebSocket("wss://hack.chat/chat-ws");
    currentNick = nick;

    socket.onopen = () => {
      document.getElementById("status").innerText = "✅ Connecté à #" + channel;

      const joinMessage = {
        cmd: "join",
        channel: channel,
        nick: currentNick
      };
      socket.send(JSON.stringify(joinMessage));
    };

    socket.onclose = () => {
      document.getElementById("status").innerText = "🔌 Déconnecté, reconnexion...";
      setTimeout(() => connect(currentNick), 2000);
    };

    socket.onerror = () => {
      document.getElementById("status").innerText = "❌ Erreur WebSocket";
    };
  }

  function sendMessage() {
    const nickInput = document.getElementById("nick").value.trim();
    const text = document.getElementById("text").value.trim();

    if (!nickInput || !text) {
      alert("Remplis ton pseudo et ton message !");
      return;
    }

    // Sauvegarde le pseudo localement
    localStorage.setItem("nickname", nickInput);

    // Si la socket n’est pas encore connectée
    if (!socket || socket.readyState !== WebSocket.OPEN) {
      connect(nickInput);
      setTimeout(() => {
        socket.send(JSON.stringify({ cmd: "chat", nick: nickInput, text: text }));
        document.getElementById("text").value = "";
      }, 500);
    } else {
      socket.send(JSON.stringify({ cmd: "chat", nick: nickInput, text: text }));
      document.getElementById("text").value = "";
    }
  }
</script>









